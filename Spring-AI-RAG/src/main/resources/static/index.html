<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI å¨æˆ¿åŠ©æ‰‹</title>

    <!-- 1. Markdown è§£æåº“ -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- 2. HTML å‡€åŒ–åº“ (é˜²æ­¢ XSS) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
    <!-- 3. ä»£ç é«˜äº®åº“ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <!-- 4. GitHub é£æ ¼ Markdown CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.2.0/github-markdown-light.min.css">

    <style>
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f7f7f8; height: 100vh; display: flex; flex-direction: column; }

        /* èŠå¤©å®¹å™¨ */
        #chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            max-width: 800px;
            margin: 0 auto;
            width: 100%;
            box-sizing: border-box;
            scroll-behavior: smooth;
        }

        .message { display: flex; align-items: flex-start; gap: 12px; max-width: 100%; }
        .avatar { width: 36px; height: 36px; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 20px; flex-shrink: 0; }
        .content { padding: 12px 16px; border-radius: 8px; font-size: 15px; line-height: 1.6; overflow-wrap: break-word; min-width: 0; position: relative; }

        /* ç”¨æˆ·æ ·å¼ */
        .message.user { flex-direction: row-reverse; }
        .message.user .avatar { background-color: #9ca3af; }
        .message.user .content { background-color: #007aff; color: white; border-radius: 18px 18px 4px 18px; }

        /* AI æ ·å¼ */
        .message.ai .avatar { background-color: #10a37f; }
        .message.ai .content { background-color: white; border: 1px solid #e5e7eb; border-radius: 4px 18px 18px 18px; width: 100%; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }

        /* è¾“å…¥åŒºåŸŸ */
        #input-area { background: white; border-top: 1px solid #e5e7eb; padding: 20px; display: flex; justify-content: center; }
        .input-group { max-width: 800px; width: 100%; display: flex; gap: 10px; }
        input[type="text"] { flex: 1; padding: 12px; border: 1px solid #d9d9e3; border-radius: 6px; font-size: 16px; outline: none; transition: border-color 0.2s; }
        input[type="text"]:focus { border-color: #10a37f; }
        button { background-color: #10a37f; color: white; border: none; padding: 0 20px; border-radius: 6px; cursor: pointer; font-weight: bold; transition: background 0.2s; }
        button:hover { background-color: #0d8a6a; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }

        /* Markdown æ ·å¼ä¿®æ­£ */
        .markdown-body { background: transparent !important; font-family: inherit !important; font-size: 15px !important; color: #374151; }
        .markdown-body p { margin-bottom: 0.8em; }
        .markdown-body pre { background-color: #f6f8fa !important; border-radius: 6px; }

        /* å…‰æ ‡åŠ¨ç”» */
        .cursor-blink { display: inline-block; width: 6px; height: 18px; background-color: #333; margin-left: 4px; vertical-align: middle; animation: blink 1s step-end infinite; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }

        /* çŠ¶æ€æ ï¼ˆè½¬åœˆ + è®¡æ—¶ï¼‰ */
        .status-bar {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-top: 8px;
            font-size: 12px;
            color: #888;
            padding-top: 8px;
            border-top: 1px dashed #eee;
        }

        .spinner {
            width: 12px;
            height: 12px;
            border: 2px solid #e5e7eb;
            border-top-color: #10a37f;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="chat-container">
    <div class="message ai">
        <div class="avatar">ğŸ¤–</div>
        <div class="content markdown-body">
            ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„ AI å¨æˆ¿åŠ©æ‰‹ã€‚
        </div>
    </div>
</div>

<div id="input-area">
    <div class="input-group">
        <input type="text" id="promptInput" placeholder="é—®é—®æ€ä¹ˆåšèœ..." value="æ€ä¹ˆåšçº¢çƒ§è‚‰">
        <button id="sendBtn" onclick="sendRequest()">å‘é€</button>
    </div>
</div>

<script>
    // é…ç½® marked
    marked.setOptions({
        renderer: new marked.Renderer(),
        highlight: function(code, lang) {
            const language = highlight.getLanguage(lang) ? lang : 'plaintext';
            return highlight.highlight(code, { language }).value;
        },
        langPrefix: 'hljs language-',
        pedantic: false,
        gfm: true,
        breaks: true,
        sanitize: false, // ä½¿ç”¨ DOMPurify
        smartypants: false,
        xhtml: false
    });

    const chatContainer = document.getElementById('chat-container');
    const promptInput = document.getElementById('promptInput');
    const sendBtn = document.getElementById('sendBtn');

    async function sendRequest() {
        const prompt = promptInput.value.trim();
        if (!prompt) return;

        // 1. UI é”å®š
        promptInput.value = '';
        promptInput.disabled = true;
        sendBtn.disabled = true;

        // 2. æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
        appendMessage('user', prompt);

        // 3. åˆ›å»º AI æ¶ˆæ¯å®¹å™¨
        const aiContainer = appendMessage('ai', '');

        // ç»“æ„ï¼šMarkdownå†…å®¹ + å…‰æ ‡ + çŠ¶æ€æ 
        const markdownDiv = document.createElement('div');
        markdownDiv.className = 'markdown-body';
        aiContainer.appendChild(markdownDiv);

        const cursor = document.createElement('span');
        cursor.className = 'cursor-blink';
        aiContainer.appendChild(cursor);

        // çŠ¶æ€æ 
        const statusBar = document.createElement('div');
        statusBar.className = 'status-bar';
        statusBar.innerHTML = `<div class="spinner"></div><span class="timer">0.0s</span>`;
        aiContainer.appendChild(statusBar);

        // è®¡æ—¶å™¨é€»è¾‘
        const startTime = Date.now();
        const timerSpan = statusBar.querySelector('.timer');
        const timerInterval = setInterval(() => {
            const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
            timerSpan.innerText = elapsed + 's';
        }, 100);

        let fullText = "";
        let buffer = "";

        try {
            // ğŸŒŸ ç¡®ä¿ URL æ˜¯åç«¯åœ°å€ï¼Œå¹¶ä¸”å·²åœ¨åç«¯å…è®¸è·¨åŸŸ
            const response = await fetch('http://localhost:8080/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ prompt: prompt })
            });

            const reader = response.body.getReader();
            const decoder = new TextDecoder("utf-8");

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;

                // æ‹¼æ¥åˆ°ç¼“å†²åŒº
                buffer += decoder.decode(value, { stream: true });
                const lines = buffer.split('\n');
                // ä¿ç•™æœ€åä¸€è¡Œï¼ˆå¯èƒ½ä¸å®Œæ•´ï¼‰
                buffer = lines.pop();

                for (const line of lines) {
                    if (line.startsWith('data:')) {
                        // ğŸŒŸ å…³é”®ä¿®æ”¹ï¼šè§£æ JSON æ ¼å¼
                        // åç«¯ç°åœ¨è¿”å›çš„æ˜¯ data: {"content": "æ–‡å­—"}
                        const jsonStr = line.substring(5).trim();

                        if (!jsonStr) continue; // è·³è¿‡ç©ºè¡Œ

                        try {
                            const dataObj = JSON.parse(jsonStr);
                            if (dataObj.content) {
                                fullText += dataObj.content;
                            }
                        } catch (e) {
                            console.error("JSON è§£æå¤±è´¥:", e, "åŸå§‹å†…å®¹:", jsonStr);
                        }
                    }
                }

                // æ¸²æŸ“
                const rawHtml = marked.parse(fullText);
                const safeHtml = DOMPurify.sanitize(rawHtml);
                markdownDiv.innerHTML = safeHtml;

                chatContainer.scrollTop = chatContainer.scrollHeight;
            }

        } catch (e) {
            markdownDiv.innerHTML += `<br><span style="color:red;">[è¿æ¥é”™è¯¯]: ${e.message}</span>`;
        } finally {
            // ç»“æŸå¤„ç†
            clearInterval(timerInterval);
            cursor.remove();

            // ç§»é™¤ Spinnerï¼Œå˜ç»¿
            const spinner = statusBar.querySelector('.spinner');
            if (spinner) spinner.remove();

            const finalTime = ((Date.now() - startTime) / 1000).toFixed(1);
            timerSpan.innerText = `ç”Ÿæˆå®Œæ¯• (è€—æ—¶ ${finalTime}s)`;
            timerSpan.style.color = '#10a37f';

            promptInput.disabled = false;
            sendBtn.disabled = false;
            promptInput.focus();
        }
    }

    function appendMessage(role, text) {
        const msgDiv = document.createElement('div');
        msgDiv.className = `message ${role}`;

        const avatarStr = role === 'user' ? 'ğŸ§‘â€ğŸ³' : 'ğŸ¤–';
        const contentHtml = role === 'user' ? `<div class="content">${text}</div>` : `<div class="content"></div>`;

        msgDiv.innerHTML = `
            <div class="avatar">${avatarStr}</div>
            ${contentHtml}
        `;

        chatContainer.appendChild(msgDiv);
        chatContainer.scrollTop = chatContainer.scrollHeight;

        return msgDiv.querySelector('.content');
    }

    promptInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendRequest();
    });
</script>

</body>
</html>